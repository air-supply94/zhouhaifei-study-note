---
title: csapp
order: 1
nav:
  title: base
  order: 5
---

## 数字

### 整数

- 逻辑右移: 左边补 0
- 算术右移: 左边补最高有效位
- 除以 2 的幂的补码除法,向下舍入: x / 2^k
- 除以 2 的幂的补码除法,向上舍入: (x + (1 << k) - 1) >> k

### 浮点数

- 原理: (-1)^s \* f ^ e
- 单精度: 1---8---23
- 双精度: 1---11---52
- bias = 2^k - 1
- 规格化(e 不全为 0 且不全为 1)
  - f = 1 + f
  - e = e - bias
- 非规格化(e 全为 0)
  - f = f
  - e = 1 - bias
- 特殊(e 全为 1)
  - f 全为 0---Infinity(s 代表正负)
  - f 不全为 0---NaN
- 舍入: 向偶舍入

## 汇编

### 2 种抽象

- 指令集体系结构或指令集架构: 定义机器级程序的格式和行为。处理器状态,指令格式,指令对状态对影响
- 虚拟内存: 提供的内存模型看上去是字节数组

### 常见寄存器

- %rip: 将要执行的下一条指令在内存中的地址
- 整数寄存器
- 浮点数寄存器
- 条件码寄存器保存最近执行的算术或逻辑指令的状态信息

## 异常

### 中断

异步发生的,是来自处理器外部的 I/O 设备的信号结果。不由任何一条专门的指令造成

### 陷阱和系统调用

是执行一条指令的结果。在用户程序和内核之间提供一个像过程一样的接口

### 故障

由错误情况引起(缺页)

- 如果被故障处理程序修正,将控制返回到引起故障的指令并重新执行
- 否则返回内核的 abort 程序,终止程序

### 终止

不可恢复的致命错误造成,从不将控制返回

## 进程

### 定义

一个执行中程序的实列。系统中的每个程序运行在某个进程的上下文

### 关键抽象

- 一个独立的逻辑控制流(程序独占使用寄存器)
- 一个私用地址空间(程序独占使用内存系统)

### 逻辑流

PC 值的序列。进程轮流使用处理器,每个进程执行一部分,然后被抢占(暂时挂起),然后轮到其他进程

### 并发流

一个逻辑流的执行在时间上和另一个逻辑流重叠

### 并发方式

- 进程
- IO 多路复用: 在一个进程调度自己逻辑流。逻辑流被抽象成状态机,数据到达文件描述符后,主程序从一个状态切换到另一个状态
  - 使用 select 函数,要求内核挂起进程,只有在一个或多个 I/O 事件发生后,才将控制返回应用程序
- 线程

### 并行

两个流并发的运行在不同处理器或者计算机上

### 用户和内核模式

一种机制。限制一个应用程序可以执行的指令以及它可以访问的地址空间范围

- 普通函数运行在用户模式中，限制了函数可以执行的指令类型与栈
- 内核模式可访问内核的栈,访问任何内存空间,执行任何指令集的指令

### 上下文切换

- 一个上下文由程序正确运行所需的状态组成。代码和数据,栈,通用目的寄存器,程序计数器,环境变量,打开文件描述符
- 调度: 当进程执行的某些时刻内核可以决定抢占当前进程,并重新开始一个先前被抢占了的进程。使用上下文切换的机制来转移到新的进程
  - 保存当前的上下文
  - 恢复某个先前被抢占进程的上下文
  - 将控制传递给这个恢复的进程

### 状态

- 运行
- 停止: 进程的执行被挂起,且不会被执行(SIGCONT 唤醒)
- 终止: 进程永远停止
- zombie: 一个终止但还未被回收但进程

### fork

- 调用一次返回 2 次: 一次父进程创建(返回子进程的 PID),在子进程(返回 0)
- 并发执行: 子进程和父进程是并发执行的独立进程
- 相同但是独立的地址空间: 子进程和父进程虚拟内存地址,代码,数据段,堆,共享库,用户栈相同
- 共享文件: 子进程可以获得父进程打开的文件描述符

### daemon

是一类在后台运行的特殊进程,用于执行特定的系统任务。很多守护进程在系统引导的时候启动,并且一直运行直到系统关闭。另一些只在需要的时候才启动,完成任务后就自动结束

### [进程间通信(IPC)](https://www.jianshu.com/p/c1015f5ffa74)

- `管道(pipe)`
- `信号和信号量`
- Message 队列
- 共享内存
- `socket`

### 线程调度算法

- 先到先服务(FCFS): 队列
- 短作业优先(SJF): 平均等待时间 = 总等待时间 / 任务数
- 优先级队列
- 多级队列模型
  - 紧急任务仍然走高优队列,非抢占执行
  - 普通任务先放到优先级仅次于高优任务的队列中,并且只分配很小的时间片。如果没有执行完成,说明任务不是很短,就将任务下调一层
  - 下面一层,最低优先级的队列中时间片很大,长任务就有更大的时间片可以用

## 线程

- 运行在一个进程上下文到逻辑流
- 包括线程 id(Thread ID, TID)、栈、PC、通用寄存器和条件码
- 由内核自动调度,由 TID 唯一标识
- 多个线程运行在同一个进程上下文,共享地址空间(代码、数据、堆、共享库)和文件描述符

### 执行模式

- 主线程: 每个进程生命周期开始时都是单一线程
- 线程上下文比进程上下文小很多
- 不是按照父子层次来组织的,进程下的每个线程是对等的
- 对等线程可以杀死任何对等线程,或者等待它的对等线程终止
- 共享变量: 被一个以上的线程引用
- 多个线程下没有办法预测操作系统执行的先后顺序

### 进度图

- 将 n 个并发线程执行模式抽象成 n 维笛卡尔坐标空间轨迹,每条轴 k 对应线程的进度
- 转换: 从一种状态到另一种状态,从一点到到相邻点到有向边,只能向上和向右
- 临界区: (L, U, S)构成一个临界区(加载、更新、保存),不能和其他线程交替执行
- 互斥: 对共享变量互斥访问
- 不安全区: 2 个临界区的交集形成的状态空间区域。安全轨迹和不安全轨迹

### 信号量

具有非负整数的全局变量,两种操作 P 和 V,s 默认为 1

- P(s)
  - 如果 s 非 0,s 减 1,并立即返回
  - 如果 s 为 0,那么挂起这个线程,直到 s 变为非 0。一个 V 操作会重启这个线程,重启后 P 将 s 减 1,并将控制返给被调用者
- V(s): 将 s 加 1。如果有任何线程在阻塞 P 操作等待 s 变成非 0,V 操作会重启这些线程种的一个,然后该线程将 s 减 1,完成它的 P 操作
- 二维信号量: 将每个共享变量与一个信号量 s 联系起来,用 P 和 V 将相应的临界区包围起来
- 互斥锁: 提供互斥为目的的二维信号量

## 信号

- 一个信号就是一条小消息,它通知进程系统发生一个类型的事件
- 发送信号: 内核通过更新目的进程的上下文的某个状态,发送一个信号给目的进程
  - 内核检测的一个系统事件
  - 显示 kill
- 接受信号: 目的进程被内核强迫以某种方式对信号做出反应

### 发送信号

- 进程组: 每个进程都只属于一个进程组,默认子进程和父进程属于一个进程组
- kill
- job: 对一条命令行求值而创建的进程。任何时刻至多有一个前台 job 或多个后台任务
- alarm

## 虚拟内存

### 基本概念

- 将主存看成是一个存储在磁盘上的地址空间的高速缓存,在主存中只保留活动区域,根据需要在主存和磁盘来回传递数据
- 为每个进程提供一致的地址空间,简化内存管理
- 保护每个进程的地址空间不被其他进程破坏
- VA: 虚拟地址(N)
- PA: 物理地址(M)
- MMU: 内存管理单元硬件。将 VA 转化成 PA,需要页表参与
- VP: 虚拟页(P=2^p)。一般是 4KB 大小
- PP: 物理页
- SRAM: L1,L2,L3 高速缓存
- DRAM: 虚拟内存的缓存

### 地址空间

- 内核虚拟内存
- 用户栈
- 共享内存
- 运行时堆
- 程序数据和代码(起点 0x00400000)

### 虚拟页

- 未分配: VM 系统未分配的页。没有任何数据与之关联,不占用磁盘空间
- 缓存的: 当前以缓存物理内存的已分配页
- 未缓存: 未缓存在物理内存的已分配页

### 页表

- 将虚拟页映射到物理页
- 是一个页表条目(PTE)数组
- 虚拟地址空间的每个页在页表中一个固定偏移量都有一个 PTE
  - PTE 由一个有效位和 n 位地址字段组成
  - 设置有效位,则地址字段对应 DRAM 对应的物理页位置
  - 没有设置有效位,空地址表示虚拟页还未被分配,非空则表示该虚拟页在磁盘的位置
- 页命中: 有效位已设置
- 缺页: DRAM 缓存不命中
  - 选择牺牲页,如果被修改则复制回磁盘。内存从磁盘复制页到牺牲页
  - 更新页表,设置有效位和地址
  - 触发异常
- 页从磁盘换入到 DRAM,从 DRAM 换出到磁盘

### 地址翻译

- TLB: 在 MMU 中包含一个关于 PTE 的缓存
  - 标记位
  - 索引位(T=2^t),由 VPN 的 t 个最第位组成
  - VPO
